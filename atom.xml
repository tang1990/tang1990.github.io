<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>这是小黑</title>
  
  <subtitle>唐小黑的博客</subtitle>
  <link href="http://tang1990@github.io/atom.xml" rel="self"/>
  
  <link href="http://tang1990@github.io/"/>
  <updated>2022-06-13T13:32:09.005Z</updated>
  <id>http://tang1990@github.io/</id>
  
  <author>
    <name>tang1990</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>hive窗口函数的使用</title>
    <link href="http://tang1990@github.io/2022/06/13/hive%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>http://tang1990@github.io/2022/06/13/hive%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2022-06-13T13:30:42.000Z</published>
    <updated>2022-06-13T13:32:09.005Z</updated>
    
    <content type="html"><![CDATA[<h1>hive窗口函数的应用</h1><h2 id="窗口函数的主要应用场景">窗口函数的主要应用场景</h2><ul class="lvl-0"><li class="lvl-2"><p>用于分区排序</p></li><li class="lvl-2"><p>动态group by</p></li><li class="lvl-2"><p>Top N</p></li><li class="lvl-2"><p>累计计算</p></li><li class="lvl-2"><p>层次查询</p></li></ul><h2 id="统计类窗口函数">统计类窗口函数</h2><p>统计类窗口函数主要有sum(),avg(),min(),max()<br>用于实现全量或分组类的连续累积统计</p><h3 id="sum">sum()</h3><p>sum函数结合开窗，可以实现窗口内数据的累全量或顺序累加结合order by可以改变累加的顺序</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">pv,  </span><br><span class="line"><span class="built_in">SUM</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> pv1, <span class="comment">-- 默认为从起点到当前行  </span></span><br><span class="line"><span class="built_in">SUM</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> pv2, <span class="comment">--从起点到当前行，结果同pv1   </span></span><br><span class="line"><span class="built_in">SUM</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid) <span class="keyword">AS</span> pv3, <span class="comment">--分组内所有行  </span></span><br><span class="line"><span class="built_in">SUM</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> pv4,  <span class="comment">--当前行+往前3行  </span></span><br><span class="line"><span class="built_in">SUM</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="number">1</span> FOLLOWING) <span class="keyword">AS</span> pv5,  <span class="comment">--当前行+往前3行+往后1行  </span></span><br><span class="line"><span class="built_in">SUM</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span> <span class="keyword">AND</span> UNBOUNDED FOLLOWING) <span class="keyword">AS</span> pv6  <span class="comment">---当前行+往后所有行    </span></span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">cookieid createtime     pv      pv1     pv2     pv3     pv4     pv5      pv6   </span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------  </span></span><br><span class="line">cookie1  <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">26</span>      <span class="number">1</span>       <span class="number">6</span>       <span class="number">26</span>  </span><br><span class="line">cookie1  <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">5</span>       <span class="number">6</span>       <span class="number">6</span>       <span class="number">26</span>      <span class="number">6</span>       <span class="number">13</span>      <span class="number">25</span>  </span><br><span class="line">cookie1  <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">7</span>       <span class="number">13</span>      <span class="number">13</span>      <span class="number">26</span>      <span class="number">13</span>      <span class="number">16</span>      <span class="number">20</span>  </span><br><span class="line">cookie1  <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">16</span>      <span class="number">16</span>      <span class="number">26</span>      <span class="number">16</span>      <span class="number">18</span>      <span class="number">13</span>  </span><br><span class="line">cookie1  <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">2</span>       <span class="number">18</span>      <span class="number">18</span>      <span class="number">26</span>      <span class="number">17</span>      <span class="number">21</span>      <span class="number">10</span>  </span><br><span class="line">cookie1  <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">4</span>       <span class="number">22</span>      <span class="number">22</span>      <span class="number">26</span>      <span class="number">16</span>      <span class="number">20</span>      <span class="number">8</span>  </span><br><span class="line">cookie1  <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">4</span>       <span class="number">26</span>      <span class="number">26</span>      <span class="number">26</span>      <span class="number">13</span>      <span class="number">13</span>      <span class="number">4</span>  </span><br></pre></td></tr></table></figure><p>pv1: 分组内从起点到当前行的pv累积，如，11号的pv1=10号的pv+11号的pv, 12号=10号+11号+12号<br>pv2: 同pv1<br>pv3: 分组内(cookie1)所有的pv累加<br>pv4: 分组内当前行+往前3行，如，11号=10号+11号， 12号=10号+11号+12号， 13号=10号+11号+12号+13号， 14号=11号+12号+13号+14号<br>pv5: 分组内当前行+往前3行+往后1行，如，14号=11号+12号+13号+14号+15号=5+7+3+2+4=21<br>pv6: 分组内当前行+往后所有行，如，13号=13号+14号+15号+16号=3+2+4+4=13，14号=14号+15号+16号=2+4+4=10</p><p>如果不指定ROWS BETWEEN,默认为从起点到当前行;<br>如果不指定ORDER BY，则将分组内所有值累加;<br>关键是理解ROWS BETWEEN含义,也叫做WINDOW子句：<br>PRECEDING：往前<br>FOLLOWING：往后<br>CURRENT ROW：当前行<br>UNBOUNDED：起点，UNBOUNDED PRECEDING 表示从前面的起点， UNBOUNDED FOLLOWING：表示到后面的终点</p><h3 id="其他分析类函数">其他分析类函数</h3><p>用法与min(),max(),avg()与SUM()基本一致</p><ul class="lvl-0"><li class="lvl-2"><p>avg()</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--AVG  </span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">pv,  </span><br><span class="line"><span class="built_in">AVG</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> pv1, <span class="comment">-- 默认为从起点到当前行  </span></span><br><span class="line"><span class="built_in">AVG</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> pv2, <span class="comment">--从起点到当前行，结果同pv1   </span></span><br><span class="line"><span class="built_in">AVG</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid) <span class="keyword">AS</span> pv3, <span class="comment">--分组内所有行  </span></span><br><span class="line"><span class="built_in">AVG</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> pv4, <span class="comment">--当前行+往前3行  </span></span><br><span class="line"><span class="built_in">AVG</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="number">1</span> FOLLOWING) <span class="keyword">AS</span> pv5, <span class="comment">--当前行+往前3行+往后1行  </span></span><br><span class="line"><span class="built_in">AVG</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span> <span class="keyword">AND</span> UNBOUNDED FOLLOWING) <span class="keyword">AS</span> pv6  <span class="comment">---当前行+往后所有行    </span></span><br><span class="line"><span class="keyword">FROM</span> lxw1234;   </span><br><span class="line">cookieid createtime     pv      pv1     pv2     pv3     pv4     pv5      pv6   </span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------  </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">1</span>       <span class="number">1.0</span>     <span class="number">1.0</span>     <span class="number">3.7142857142857144</span>      <span class="number">1.0</span>     <span class="number">3.0</span>     <span class="number">3.7142857142857144</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">5</span>       <span class="number">3.0</span>     <span class="number">3.0</span>     <span class="number">3.7142857142857144</span>      <span class="number">3.0</span>     <span class="number">4.333333333333333</span>       <span class="number">4.166666666666667</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">7</span>       <span class="number">4.333333333333333</span>       <span class="number">4.333333333333333</span>       <span class="number">3.7142857142857144</span>      <span class="number">4.333333333333333</span>       <span class="number">4.0</span>     <span class="number">4.0</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">4.0</span>     <span class="number">4.0</span>     <span class="number">3.7142857142857144</span>      <span class="number">4.0</span>     <span class="number">3.6</span>     <span class="number">3.25</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">2</span>       <span class="number">3.6</span>     <span class="number">3.6</span>     <span class="number">3.7142857142857144</span>      <span class="number">4.25</span>    <span class="number">4.2</span>     <span class="number">3.3333333333333335</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">4</span>       <span class="number">3.6666666666666665</span>      <span class="number">3.6666666666666665</span>      <span class="number">3.7142857142857144</span>      <span class="number">4.0</span>     <span class="number">4.0</span>     <span class="number">4.0</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">4</span>       <span class="number">3.7142857142857144</span>      <span class="number">3.7142857142857144</span>      <span class="number">3.7142857142857144</span>      <span class="number">3.25</span>    <span class="number">3.25</span>    <span class="number">4.0</span>  </span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>max()</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--MAX  </span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">pv,  </span><br><span class="line"><span class="built_in">MAX</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> pv1, <span class="comment">-- 默认为从起点到当前行  </span></span><br><span class="line"><span class="built_in">MAX</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> pv2, <span class="comment">--从起点到当前行，结果同pv1   </span></span><br><span class="line"><span class="built_in">MAX</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid) <span class="keyword">AS</span> pv3, <span class="comment">--分组内所有行  </span></span><br><span class="line"><span class="built_in">MAX</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> pv4, <span class="comment">--当前行+往前3行  </span></span><br><span class="line"><span class="built_in">MAX</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="number">1</span> FOLLOWING) <span class="keyword">AS</span> pv5, <span class="comment">--当前行+往前3行+往后1行  </span></span><br><span class="line"><span class="built_in">MAX</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span> <span class="keyword">AND</span> UNBOUNDED FOLLOWING) <span class="keyword">AS</span> pv6  <span class="comment">---当前行+往后所有行    </span></span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">cookieid createtime     pv      pv1     pv2     pv3     pv4     pv5      pv6   </span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------  </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">7</span>       <span class="number">1</span>       <span class="number">5</span>       <span class="number">7</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">5</span>       <span class="number">5</span>       <span class="number">5</span>       <span class="number">7</span>       <span class="number">5</span>       <span class="number">7</span>       <span class="number">7</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">4</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">2</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">4</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">4</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">4</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">4</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">7</span>       <span class="number">4</span>       <span class="number">4</span>       <span class="number">4</span>  </span><br></pre></td></tr></table></figure><ul class="lvl-0"><li class="lvl-2"><p>min()</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--MIN  </span></span><br><span class="line"><span class="keyword">SELECT</span> cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">pv,  </span><br><span class="line"><span class="built_in">MIN</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> pv1, <span class="comment">-- 默认为从起点到当前行  </span></span><br><span class="line"><span class="built_in">MIN</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> UNBOUNDED PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> pv2, <span class="comment">--从起点到当前行，结果同pv1   </span></span><br><span class="line"><span class="built_in">MIN</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid) <span class="keyword">AS</span> pv3,  <span class="comment">--分组内所有行  </span></span><br><span class="line"><span class="built_in">MIN</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span>) <span class="keyword">AS</span> pv4,  <span class="comment">--当前行+往前3行  </span></span><br><span class="line"><span class="built_in">MIN</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="number">3</span> PRECEDING <span class="keyword">AND</span> <span class="number">1</span> FOLLOWING) <span class="keyword">AS</span> pv5,  <span class="comment">--当前行+往前3行+往后1行  </span></span><br><span class="line"><span class="built_in">MIN</span>(pv) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime <span class="keyword">ROWS</span> <span class="keyword">BETWEEN</span> <span class="keyword">CURRENT</span> <span class="type">ROW</span> <span class="keyword">AND</span> UNBOUNDED FOLLOWING) <span class="keyword">AS</span> pv6  <span class="comment">---当前行+往后所有行    </span></span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">cookieid createtime     pv      pv1     pv2     pv3     pv4     pv5      pv6   </span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------  </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">5</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">2</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">7</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">2</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">2</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">2</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">2</span>       <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">4</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">2</span>       <span class="number">2</span>       <span class="number">4</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">4</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">2</span>       <span class="number">2</span>       <span class="number">4</span>  </span><br></pre></td></tr></table></figure><h2 id="排序类窗口函数">排序类窗口函数</h2><p>排序类窗口函数主要用于以下功能</p><ul class="lvl-0"><li class="lvl-2"><p>分组排序编号</p></li><li class="lvl-2"><p>TOP-N提取</p></li><li class="lvl-2"><p>分组百分比</p></li><li class="lvl-2"><p>组内比例</p></li></ul><p>代表函数NTILE(),ROW_NUMBER(),RANK(),DENSE_RANK(),CUME_DIST(),PERCENT_RANK()</p><div class="danger"><p>该类型函数不支持window字句</p></div><h3 id="ntile">ntile()</h3><p>NTILE(n)，用于将分组数据按照顺序切分成n片，返回当前切片值<br>NTILE不支持ROWS BETWEEN<br>如果切片不均匀，默认增加第一个切片的分布</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line">cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">pv,  </span><br><span class="line"><span class="built_in">NTILE</span>(<span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn1,    <span class="comment">--分组内将数据分成2片  </span></span><br><span class="line"><span class="built_in">NTILE</span>(<span class="number">3</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn2,  <span class="comment">--分组内将数据分成3片  </span></span><br><span class="line"><span class="built_in">NTILE</span>(<span class="number">4</span>) <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn3        <span class="comment">--将所有数据分成4片  </span></span><br><span class="line"><span class="keyword">FROM</span> lxw1234   </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> cookieid,createtime;  </span><br><span class="line">   </span><br><span class="line">cookieid <span class="keyword">day</span>           pv       rn1     rn2     rn3  </span><br><span class="line"><span class="comment">-------------------------------------------------  </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">5</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">7</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">2</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">1</span>       <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">2</span>       <span class="number">2</span>       <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">4</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">3</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">4</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">4</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">2</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">3</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">5</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">2</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">6</span>       <span class="number">1</span>       <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">3</span>       <span class="number">2</span>       <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">9</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">4</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">7</span>       <span class="number">2</span>       <span class="number">3</span>       <span class="number">4</span>  </span><br></pre></td></tr></table></figure><h3 id="row-number">row_number()</h3><p>ROW_NUMBER() –从1开始，按照顺序，生成分组内记录的序列比如，按照pv降序排列，生成分组内每天的pv名次</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line">cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">pv,  </span><br><span class="line"><span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">desc</span>) <span class="keyword">AS</span> rn   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">cookieid <span class="keyword">day</span>           pv       rn  </span><br><span class="line"><span class="comment">-------------------------------------------   </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">7</span>       <span class="number">1</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">5</span>       <span class="number">2</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">4</span>       <span class="number">3</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">4</span>       <span class="number">4</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">5</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">2</span>       <span class="number">6</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">1</span>       <span class="number">7</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">9</span>       <span class="number">1</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">7</span>       <span class="number">2</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">6</span>       <span class="number">3</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">5</span>       <span class="number">4</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">3</span>       <span class="number">5</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">3</span>       <span class="number">6</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">2</span>       <span class="number">7</span> </span><br></pre></td></tr></table></figure><h3 id="rank-和dense-rank">rank()和dense_rank()</h3><ul class="lvl-0"><li class="lvl-2"><p>RANK() 生成数据项在分组中的排名，排名相等会在名次中留下空位</p></li><li class="lvl-2"><p>DENSE_RANK() 生成数据项在分组中的排名，排名相等会在名次中不会留下空位</p></li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line">cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">pv,  </span><br><span class="line"><span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">desc</span>) <span class="keyword">AS</span> rn1,  </span><br><span class="line"><span class="built_in">DENSE_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">desc</span>) <span class="keyword">AS</span> rn2,  </span><br><span class="line"><span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> pv <span class="keyword">DESC</span>) <span class="keyword">AS</span> rn3   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234   </span><br><span class="line"><span class="keyword">WHERE</span> cookieid <span class="operator">=</span> <span class="string">&#x27;cookie1&#x27;</span>;  </span><br><span class="line">   </span><br><span class="line">cookieid <span class="keyword">day</span>           pv       rn1     rn2     rn3   </span><br><span class="line"><span class="comment">--------------------------------------------------   </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">7</span>       <span class="number">1</span>       <span class="number">1</span>       <span class="number">1</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-11</span>      <span class="number">5</span>       <span class="number">2</span>       <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">4</span>       <span class="number">3</span>       <span class="number">3</span>       <span class="number">3</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">4</span>       <span class="number">3</span>       <span class="number">3</span>       <span class="number">4</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">5</span>       <span class="number">4</span>       <span class="number">5</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-14</span>      <span class="number">2</span>       <span class="number">6</span>       <span class="number">5</span>       <span class="number">6</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span>      <span class="number">1</span>       <span class="number">7</span>       <span class="number">6</span>       <span class="number">7</span>  </span><br></pre></td></tr></table></figure><p>rn1: 15号和16号并列第3, 13号排第5<br>rn2: 15号和16号并列第3, 13号排第4<br>rn3: 如果相等，则按记录值排序，生成唯一的次序，如果所有记录值都相等，会随机排吧</p><h3 id="cume-dist">cume_dist()</h3><p>计算分组类小于等于当前值的行数/分组内总行数</p><p>比如，统计小于等于当前薪水的人数，所占总人数的比例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line">dept,  </span><br><span class="line">userid,  </span><br><span class="line">sal,  </span><br><span class="line"><span class="built_in">CUME_DIST</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sal) <span class="keyword">AS</span> rn1,  </span><br><span class="line"><span class="built_in">CUME_DIST</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept <span class="keyword">ORDER</span> <span class="keyword">BY</span> sal) <span class="keyword">AS</span> rn2   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">dept    userid   sal   rn1       rn2   </span><br><span class="line"><span class="comment">-------------------------------------------  </span></span><br><span class="line">d1      user1   <span class="number">1000</span>    <span class="number">0.2</span>     <span class="number">0.3333333333333333</span>  </span><br><span class="line">d1      user2   <span class="number">2000</span>    <span class="number">0.4</span>     <span class="number">0.6666666666666666</span>  </span><br><span class="line">d1      user3   <span class="number">3000</span>    <span class="number">0.6</span>     <span class="number">1.0</span>  </span><br><span class="line">d2      user4   <span class="number">4000</span>    <span class="number">0.8</span>     <span class="number">0.5</span>  </span><br><span class="line">d2      user5   <span class="number">5000</span>    <span class="number">1.0</span>     <span class="number">1.0</span> </span><br></pre></td></tr></table></figure><p>rn1: 没有partition,所有数据均为1组，总行数为5，<br>第一行：小于等于1000的行数为1，因此，1/5=0.2<br>第三行：小于等于3000的行数为3，因此，3/5=0.6<br>rn2: 按照部门分组，dpet=d1的行数为3,<br>第二行：小于等于2000的行数为2，因此，2/3=0.6666666666666666</p><h3 id="PERCENT-RANK">PERCENT_RANK()</h3><p>分组内当前行的RANK值-1/分组内总行数-1</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line">dept,  </span><br><span class="line">userid,  </span><br><span class="line">sal,  </span><br><span class="line"><span class="built_in">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sal) <span class="keyword">AS</span> rn1,   <span class="comment">--分组内  </span></span><br><span class="line"><span class="built_in">RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">ORDER</span> <span class="keyword">BY</span> sal) <span class="keyword">AS</span> rn11,          <span class="comment">--分组内RANK值  </span></span><br><span class="line"><span class="built_in">SUM</span>(<span class="number">1</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> <span class="keyword">NULL</span>) <span class="keyword">AS</span> rn12,     <span class="comment">--分组内总行数  </span></span><br><span class="line"><span class="built_in">PERCENT_RANK</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> dept <span class="keyword">ORDER</span> <span class="keyword">BY</span> sal) <span class="keyword">AS</span> rn2   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">dept    userid  sal     rn1    rn11     rn12    rn2  </span><br><span class="line"><span class="comment">---------------------------------------------------  </span></span><br><span class="line">d1      user1   <span class="number">1000</span>    <span class="number">0.0</span>     <span class="number">1</span>       <span class="number">5</span>       <span class="number">0.0</span>  </span><br><span class="line">d1      user2   <span class="number">2000</span>    <span class="number">0.25</span>    <span class="number">2</span>       <span class="number">5</span>       <span class="number">0.5</span>  </span><br><span class="line">d1      user3   <span class="number">3000</span>    <span class="number">0.5</span>     <span class="number">3</span>       <span class="number">5</span>       <span class="number">1.0</span>  </span><br><span class="line">d2      user4   <span class="number">4000</span>    <span class="number">0.75</span>    <span class="number">4</span>       <span class="number">5</span>       <span class="number">0.0</span>  </span><br><span class="line">d2      user5   <span class="number">5000</span>    <span class="number">1.0</span>     <span class="number">5</span>       <span class="number">5</span>       <span class="number">1.0</span> </span><br></pre></td></tr></table></figure><p>rn1: rn1 = (rn11-1) / (rn12-1)<br>第一行,(1-1)/(5-1)=0/4=0<br>第二行,(2-1)/(5-1)=1/4=0.25<br>第四行,(4-1)/(5-1)=3/4=0.75<br>rn2: 按照dept分组，<br>dept=d1的总行数为3<br>第一行，(1-1)/(3-1)=0<br>第三行，(3-1)/(3-1)=1</p><h2 id="时间序列相关的开窗函数">时间序列相关的开窗函数</h2><p>主要包含LAG(),LEAD(),FIRST_VALUE(),LAST_VALUE()</p><h3 id="lag">lag()</h3><p>LAG(col,n,DEFAULT) 用于统计窗口内往上第n行值第一个参数为列名，第二个参数为往上第n行（可选，默认为1），第三个参数为默认值（当往上第n行为NULL时候，取默认值，如不指定，则为NULL）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">url,  </span><br><span class="line"><span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn,  </span><br><span class="line"><span class="built_in">LAG</span>(createtime,<span class="number">1</span>,<span class="string">&#x27;1970-01-01 00:00:00&#x27;</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> last_1_time,  </span><br><span class="line"><span class="built_in">LAG</span>(createtime,<span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> last_2_time   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">cookieid createtime             url    rn       last_1_time             last_2_time  </span><br><span class="line"><span class="comment">-------------------------------------------------------------------------------------------  </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     url1    <span class="number">1</span>       <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>     <span class="keyword">NULL</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     url2    <span class="number">2</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     <span class="keyword">NULL</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">1</span>url3   <span class="number">3</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     url4    <span class="number">4</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     url5    <span class="number">5</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     url6    <span class="number">6</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     url7    <span class="number">7</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     url11   <span class="number">1</span>       <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>     <span class="keyword">NULL</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     url22   <span class="number">2</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     <span class="keyword">NULL</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">1</span>url33  <span class="number">3</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     url44   <span class="number">4</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     url55   <span class="number">5</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     url66   <span class="number">6</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     url77   <span class="number">7</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>  </span><br></pre></td></tr></table></figure><p>last_1_time: 指定了往上第1行的值，default为’1970-01-01 00:00:00’<br>cookie1第一行，往上1行为NULL,因此取默认值 1970-01-01 00:00:00<br>cookie1第三行，往上1行值为第二行值，2015-04-10 10:00:02<br>cookie1第六行，往上1行值为第五行值，2015-04-10 10:50:01<br>last_2_time: 指定了往上第2行的值，为指定默认值<br>cookie1第一行，往上2行为NULL<br>cookie1第二行，往上2行为NULL<br>cookie1第四行，往上2行为第二行值，2015-04-10 10:00:02<br>cookie1第七行，往上2行为第五行值，2015-04-10 10:50:01</p><h3 id="lead">lead()</h3><p>与LAG相反<br>LEAD(col,n,DEFAULT) 用于统计窗口内往下第n行值第一个参数为列名，第二个参数为往下第n行（可选，默认为1），第三个参数为默认值（当往下第n行为NULL时候，取默认值，如不指定，则为NULL）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">url,  </span><br><span class="line"><span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn,  </span><br><span class="line"><span class="built_in">LEAD</span>(createtime,<span class="number">1</span>,<span class="string">&#x27;1970-01-01 00:00:00&#x27;</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> next_1_time,  </span><br><span class="line"><span class="built_in">LEAD</span>(createtime,<span class="number">2</span>) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> next_2_time   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">cookieid createtime             url    rn       next_1_time             next_2_time   </span><br><span class="line"><span class="comment">-------------------------------------------------------------------------------------------  </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     url1    <span class="number">1</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     url2    <span class="number">2</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">1</span>url3   <span class="number">3</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     url4    <span class="number">4</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     url5    <span class="number">5</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     url6    <span class="number">6</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     <span class="keyword">NULL</span>  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     url7    <span class="number">7</span>       <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>     <span class="keyword">NULL</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     url11   <span class="number">1</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     url22   <span class="number">2</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">1</span>url33  <span class="number">3</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     url44   <span class="number">4</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     url55   <span class="number">5</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     url66   <span class="number">6</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     <span class="keyword">NULL</span>  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     url77   <span class="number">7</span>       <span class="number">1970</span><span class="number">-01</span><span class="number">-01</span> <span class="number">00</span>:<span class="number">00</span>:<span class="number">00</span>     <span class="keyword">NULL</span>  </span><br></pre></td></tr></table></figure><h3 id="FIRST-VALUE">FIRST_VALUE()</h3><p>取分组内排序后，截止到当前行，第一个值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">url,  </span><br><span class="line"><span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn,  </span><br><span class="line"><span class="built_in">FIRST_VALUE</span>(url) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> first1   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">cookieid  createtime            url     rn      first1  </span><br><span class="line"><span class="comment">---------------------------------------------------------  </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     url1    <span class="number">1</span>       url1  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     url2    <span class="number">2</span>       url1  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">1</span>url3   <span class="number">3</span>       url1  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     url4    <span class="number">4</span>       url1  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     url5    <span class="number">5</span>       url1  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     url6    <span class="number">6</span>       url1  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     url7    <span class="number">7</span>       url1  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     url11   <span class="number">1</span>       url11  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     url22   <span class="number">2</span>       url11  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">1</span>url33  <span class="number">3</span>       url11  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     url44   <span class="number">4</span>       url11  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     url55   <span class="number">5</span>       url11  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     url66   <span class="number">6</span>       url11  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     url77   <span class="number">7</span>       url11  </span><br></pre></td></tr></table></figure><h3 id="LAST-VALUE">LAST_VALUE()</h3><p>取分组内排序后，截止到当前行，最后一个值</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> cookieid,  </span><br><span class="line">createtime,  </span><br><span class="line">url,  </span><br><span class="line"><span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> rn,  </span><br><span class="line"><span class="built_in">LAST_VALUE</span>(url) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> cookieid <span class="keyword">ORDER</span> <span class="keyword">BY</span> createtime) <span class="keyword">AS</span> last1   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234;  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line">cookieid  createtime            url    rn       last1    </span><br><span class="line"><span class="comment">-----------------------------------------------------------------  </span></span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     url1    <span class="number">1</span>       url1  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     url2    <span class="number">2</span>       url2  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">1</span>url3   <span class="number">3</span>       <span class="number">1</span>url3  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     url4    <span class="number">4</span>       url4  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     url5    <span class="number">5</span>       url5  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     url6    <span class="number">6</span>       url6  </span><br><span class="line">cookie1 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     url7    <span class="number">7</span>       url7  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">00</span>     url11   <span class="number">1</span>       url11  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">00</span>:<span class="number">02</span>     url22   <span class="number">2</span>       url22  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">03</span>:<span class="number">04</span>     <span class="number">1</span>url33  <span class="number">3</span>       <span class="number">1</span>url33  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">10</span>:<span class="number">00</span>     url44   <span class="number">4</span>       url44  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">01</span>     url55   <span class="number">5</span>       url55  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">10</span>:<span class="number">50</span>:<span class="number">05</span>     url66   <span class="number">6</span>       url66  </span><br><span class="line">cookie2 <span class="number">2015</span><span class="number">-04</span><span class="number">-10</span> <span class="number">11</span>:<span class="number">00</span>:<span class="number">00</span>     url77   <span class="number">7</span>       url77  </span><br></pre></td></tr></table></figure><h2 id="维度聚合">维度聚合</h2><h3 id="GROUPING-SETS">GROUPING SETS()</h3><p>在一个GROUP BY查询中，根据不同的维度组合进行聚合，等价于将不同维度的GROUP BY结果集进行UNION ALL<br>例一：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line"><span class="keyword">month</span>,  </span><br><span class="line"><span class="keyword">day</span>,  </span><br><span class="line"><span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,  </span><br><span class="line">GROUPING__ID   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234   </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span>   </span><br><span class="line"><span class="keyword">GROUPING</span> SETS (<span class="keyword">month</span>,<span class="keyword">day</span>)   </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;  </span><br><span class="line">   </span><br><span class="line"><span class="keyword">month</span>      <span class="keyword">day</span>            uv      GROUPING__ID  </span><br><span class="line"><span class="comment">------------------------------------------------  </span></span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>    <span class="keyword">NULL</span>            <span class="number">5</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>    <span class="keyword">NULL</span>            <span class="number">6</span>       <span class="number">1</span>  </span><br><span class="line"><span class="keyword">NULL</span>       <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>      <span class="number">4</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>       <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>      <span class="number">1</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br></pre></td></tr></table></figure><p>上面的查询，等价于：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">NULL</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">1</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>   </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span>   </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">2</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>  </span><br></pre></td></tr></table></figure><p>例二：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line"><span class="keyword">month</span>,  </span><br><span class="line"><span class="keyword">day</span>,  </span><br><span class="line"><span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,  </span><br><span class="line">GROUPING__ID   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234   </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span>   </span><br><span class="line"><span class="keyword">GROUPING</span> SETS (<span class="keyword">month</span>,<span class="keyword">day</span>,(<span class="keyword">month</span>,<span class="keyword">day</span>))   </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;  </span><br><span class="line">   </span><br><span class="line"><span class="keyword">month</span>         <span class="keyword">day</span>             uv      GROUPING__ID  </span><br><span class="line"><span class="comment">------------------------------------------------  </span></span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>       <span class="keyword">NULL</span>            <span class="number">5</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>       <span class="keyword">NULL</span>            <span class="number">6</span>       <span class="number">1</span>  </span><br><span class="line"><span class="keyword">NULL</span>          <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>      <span class="number">4</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>          <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>      <span class="number">1</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>          <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>          <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>          <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>          <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>       <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>      <span class="number">4</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>       <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>      <span class="number">1</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>       <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br></pre></td></tr></table></figure><p>等价于：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">NULL</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">1</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>   </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span>   </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">2</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>  </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span>   </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">3</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span></span><br></pre></td></tr></table></figure><p>其中的 <mark>GROUPING__ID</mark> ，表示结果属于哪一个分组集合。</p><h3 id="cube">cube()</h3><p>根据GROUP BY的维度的所有组合进行聚合</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line"><span class="keyword">month</span>,  </span><br><span class="line"><span class="keyword">day</span>,  </span><br><span class="line"><span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,  </span><br><span class="line">GROUPING__ID   </span><br><span class="line"><span class="keyword">FROM</span> lxw1234   </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span>   </span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">CUBE</span>   </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"><span class="keyword">month</span>           <span class="keyword">day</span>             uv     GROUPING__ID  </span><br><span class="line"><span class="comment">--------------------------------------------  </span></span><br><span class="line"><span class="keyword">NULL</span>            <span class="keyword">NULL</span>            <span class="number">7</span>       <span class="number">0</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>         <span class="keyword">NULL</span>            <span class="number">5</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>         <span class="keyword">NULL</span>            <span class="number">6</span>       <span class="number">1</span>  </span><br><span class="line"><span class="keyword">NULL</span>            <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>            <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>            <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>            <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">2</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>            <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>      <span class="number">4</span>       <span class="number">2</span>  </span><br><span class="line"><span class="keyword">NULL</span>            <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>      <span class="number">1</span>       <span class="number">2</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>         <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>      <span class="number">4</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>         <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>      <span class="number">1</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>         <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>         <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>         <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>         <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br></pre></td></tr></table></figure><p>等价于:</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">等价于  </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span>,<span class="keyword">NULL</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">0</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234  </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span>   </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">NULL</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">1</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>   </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span>   </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">NULL</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">2</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>  </span><br><span class="line"><span class="keyword">UNION</span> <span class="keyword">ALL</span>   </span><br><span class="line"><span class="keyword">SELECT</span> <span class="keyword">month</span>,<span class="keyword">day</span>,<span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,<span class="number">3</span> <span class="keyword">AS</span> GROUPING__ID <span class="keyword">FROM</span> lxw1234 <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span>  </span><br></pre></td></tr></table></figure><h3 id="rollup">rollup()</h3><p>该函数是cube的子集，以最左侧的维度为主，进行逐层的层级聚合</p><p>例如：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 以month维度进行层级聚合：  </span></span><br><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line"><span class="keyword">month</span>,  </span><br><span class="line"><span class="keyword">day</span>,  </span><br><span class="line"><span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,  </span><br><span class="line">GROUPING__ID    </span><br><span class="line"><span class="keyword">FROM</span> lxw1234   </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">month</span>,<span class="keyword">day</span> </span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>   </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;  </span><br><span class="line">   </span><br><span class="line"><span class="keyword">month</span>        <span class="keyword">day</span>             uv     GROUPING__ID  </span><br><span class="line"><span class="comment">---------------------------------------------------  </span></span><br><span class="line"><span class="keyword">NULL</span>             <span class="keyword">NULL</span>            <span class="number">7</span>       <span class="number">0</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>          <span class="keyword">NULL</span>            <span class="number">5</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>          <span class="keyword">NULL</span>            <span class="number">6</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>          <span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>      <span class="number">4</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span>          <span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>      <span class="number">1</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>          <span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>          <span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">3</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>          <span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span>          <span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line">   </span><br><span class="line"><span class="comment">-- 可以实现这样的上钻过程：  </span></span><br><span class="line"><span class="comment">-- 月天的UV-&gt;月的UV-&gt;总UV  </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--把month和day调换顺序，则以day维度进行层级聚合：  </span></span><br><span class="line">   </span><br><span class="line"><span class="keyword">SELECT</span>   </span><br><span class="line"><span class="keyword">day</span>,  </span><br><span class="line"><span class="keyword">month</span>,  </span><br><span class="line"><span class="built_in">COUNT</span>(<span class="keyword">DISTINCT</span> cookieid) <span class="keyword">AS</span> uv,  </span><br><span class="line">GROUPING__ID    </span><br><span class="line"><span class="keyword">FROM</span> lxw1234   </span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">day</span>,<span class="keyword">month</span>   </span><br><span class="line"><span class="keyword">WITH</span> <span class="keyword">ROLLUP</span>   </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span> GROUPING__ID;  </span><br><span class="line">   </span><br><span class="line">   </span><br><span class="line"><span class="keyword">day</span>         <span class="keyword">month</span>              uv     GROUPING__ID  </span><br><span class="line"><span class="comment">-------------------------------------------------------  </span></span><br><span class="line"><span class="keyword">NULL</span>            <span class="keyword">NULL</span>               <span class="number">7</span>       <span class="number">0</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="keyword">NULL</span>               <span class="number">3</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>      <span class="keyword">NULL</span>               <span class="number">1</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="keyword">NULL</span>               <span class="number">2</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>      <span class="keyword">NULL</span>               <span class="number">4</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="keyword">NULL</span>               <span class="number">2</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="keyword">NULL</span>               <span class="number">2</span>       <span class="number">1</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-12</span>      <span class="number">2015</span><span class="number">-04</span>            <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span><span class="number">-10</span>      <span class="number">2015</span><span class="number">-03</span>            <span class="number">4</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-03</span><span class="number">-12</span>      <span class="number">2015</span><span class="number">-03</span>            <span class="number">1</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-13</span>      <span class="number">2015</span><span class="number">-04</span>            <span class="number">3</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-15</span>      <span class="number">2015</span><span class="number">-04</span>            <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line"><span class="number">2015</span><span class="number">-04</span><span class="number">-16</span>      <span class="number">2015</span><span class="number">-04</span>            <span class="number">2</span>       <span class="number">3</span>  </span><br><span class="line">   </span><br><span class="line"><span class="comment">-- 可以实现这样的上钻过程：  </span></span><br><span class="line"><span class="comment">-- 天月的UV-&gt;天的UV-&gt;总UV  </span></span><br><span class="line"><span class="comment">-- （这里，根据天和月进行聚合，和根据天聚合结果一样，因为有父子关系，如果是其他维度组合的话，就会不一样）  </span></span><br></pre></td></tr></table></figure><h2 id="参考链接">参考链接</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="http://lxw1234.com/archives/tag/hive-window-functions">lxw的大数据田地</a></p></li><li class="lvl-2"><p><a href="https://blog.csdn.net/xiepeifeng/article/details/42676567">hive之窗口函数理解与实践</a></p></li><li class="lvl-2"><p><a href="https://www.cnblogs.com/skyEva/p/5730531.html">博客园</a></p></li><li class="lvl-2"><p><a href="https://blog.csdn.net/abc200941410128/article/details/78408942">一文读懂Hive分析窗口函数（hive做累计、分组、排序、层次等计算）</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;hive窗口函数的应用&lt;/h1&gt;
&lt;h2 id=&quot;窗口函数的主要应用场景&quot;&gt;窗口函数的主要应用场景&lt;/h2&gt;
&lt;ul class=&quot;lvl-0&quot;&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;用于分区排序&lt;/p&gt;
&lt;/li&gt;
&lt;li class=&quot;lvl-2&quot;&gt;
&lt;p&gt;动</summary>
      
    
    
    
    <category term="大数据" scheme="http://tang1990@github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
    <category term="hive" scheme="http://tang1990@github.io/tags/hive/"/>
    
    <category term="大数据" scheme="http://tang1990@github.io/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    <category term="窗口函数" scheme="http://tang1990@github.io/tags/%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0/"/>
    
  </entry>
  
  <entry>
    <title>centos7离线安装postgres10</title>
    <link href="http://tang1990@github.io/2022/06/12/centos7%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85postgres10/"/>
    <id>http://tang1990@github.io/2022/06/12/centos7%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85postgres10/</id>
    <published>2022-06-12T14:26:44.000Z</published>
    <updated>2022-06-12T14:33:19.837Z</updated>
    
    <content type="html"><![CDATA[<h1>centos7离线安装postgres10</h1><h2 id="问题背景">问题背景</h2><p>在项目的部署的DS中，使用python组件连接PG数据库时，出现如下报错</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psycopg2.OperationalError: SCRAM authentication requires libpq version 10 or above</span><br></pre></td></tr></table></figure><p><img src="https://cdn.jsdelivr.net/gh/tang1990/mypic@main/202206122231361.png" alt="Img"></p><h2 id="问题排查">问题排查</h2><p>网上查询相关资料，是因为libpg的版本过低导致。在centos中使用yum install时，安装的版本最只能到9.2.24, 该版本不支持SCRAM，需要更新到10.0以上的版本。</p><p>可以使用以下命令查询pg的版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pg_config --version</span><br></pre></td></tr></table></figure><h2 id="问题解决">问题解决</h2><p>因为服务器centos7,使用内网环境无法在线更新软件,在虚拟机上使用如下方法下载升级需要的rpm安装包</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 更换rmp源</span><br><span class="line">rpm -Uvh https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum install --downloadonly --downloaddir=/gp postgresql10-devel</span><br></pre></td></tr></table></figure><p>下载后得到三个rpm包</p><ul class="lvl-0"><li class="lvl-2"><p>postgresql10-10.21-1PGDG.rhel7.x86_64.rpm</p></li><li class="lvl-2"><p>postgresql10-devel-10.21-1PGDG.rhel7.x86_64.rpm</p></li><li class="lvl-2"><p>postgresql10-libs-10.21-1PGDG.rhel7.x86_64.rpm</p></li></ul><p>将rpm包上传的服务器后使用如下命令安装：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall -y *.rpm</span><br></pre></td></tr></table></figure><p>或</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -Uvh --force --nodeps *.rpm</span><br></pre></td></tr></table></figure><p>安装执行完成先删除系统中原有的pg_config</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find / -type f -name &quot;pg_config&quot;</span><br><span class="line"></span><br><span class="line">rm -rf /usr/bin/pg_config</span><br></pre></td></tr></table></figure><p>然后使用如命令建立软链接：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/pgsql-10/bin/pg_config pg_config</span><br></pre></td></tr></table></figure><p>再次查看pg_config版本，已升级到10.21。重新运行python脚本，执行成功。</p><h2 id="参考链接">参考链接</h2><ul class="lvl-0"><li class="lvl-2"><p><a href="https://opensuse.pkgs.org/15.3/opensuse-oss-x86_64/postgresql10-devel-10.17-8.35.1.x86_64.rpm.html">python SCRAM authentication requires libpq version 10 or above</a></p></li><li class="lvl-2"><p><a href="https://blog.csdn.net/yinlongfei_love/article/details/80728896">Centos 7 离线安装postgresql 10</a></p></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;centos7离线安装postgres10&lt;/h1&gt;
&lt;h2 id=&quot;问题背景&quot;&gt;问题背景&lt;/h2&gt;
&lt;p&gt;在项目的部署的DS中，使用python组件连接PG数据库时，出现如下报错&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;tabl</summary>
      
    
    
    
    <category term="linux" scheme="http://tang1990@github.io/categories/linux/"/>
    
    
    <category term="linux" scheme="http://tang1990@github.io/tags/linux/"/>
    
    <category term="centos" scheme="http://tang1990@github.io/tags/centos/"/>
    
    <category term="python" scheme="http://tang1990@github.io/tags/python/"/>
    
    <category term="postgres" scheme="http://tang1990@github.io/tags/postgres/"/>
    
  </entry>
  
  <entry>
    <title>关于DS调度执行hive脚本吊死问题的分析及处理</title>
    <link href="http://tang1990@github.io/2022/06/10/%E5%85%B3%E4%BA%8EDS%E8%B0%83%E5%BA%A6%E6%89%A7%E8%A1%8Chive%E8%84%9A%E6%9C%AC%E5%90%8A%E6%AD%BB%E9%97%AE%E9%A2%98%E7%9A%84%E5%88%86%E6%9E%90%E5%8F%8A%E5%A4%84%E7%90%86/"/>
    <id>http://tang1990@github.io/2022/06/10/%E5%85%B3%E4%BA%8EDS%E8%B0%83%E5%BA%A6%E6%89%A7%E8%A1%8Chive%E8%84%9A%E6%9C%AC%E5%90%8A%E6%AD%BB%E9%97%AE%E9%A2%98%E7%9A%84%E5%88%86%E6%9E%90%E5%8F%8A%E5%A4%84%E7%90%86/</id>
    <published>2022-06-10T14:05:38.000Z</published>
    <updated>2022-06-13T13:12:39.304Z</updated>
    
    <content type="html"><![CDATA[<h1>关于DS调度执行hive脚本吊死问题的分析及处理</h1><h2 id="问题现象">问题现象</h2><p>在DS执行hive脚本时,经常会出现hive任务实际执行完成，但对应的工作任务一致处于执行中状态无法结束的问题。</p><p>在前两次运行,脚本均在三分钟内执行完毕，并正常识别到结束状态第三次运行时,脚本长期不结束执行。查看任务日志，发现实际任务早已执行完成。</p><h2 id="问题分析">问题分析</h2><h3 id="异常点分析">异常点分析</h3><p>对比前后三次的任务日志。发现前两次的任务执行时,hive自动均为任务分配了一个APPLICATION,<br>例如：下图为任务第二次执行的日志<img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102216001.png?token=ADEGZTT6NKVORRSQMUL5HJTCUNJGE" alt="Img"><br>程序检测到了该任务分配了一个application,其ID为<code>application_1651842678755_885090</code></p><p>程序在9:46:00时检测到该application的状态结束，与任务流的结束时间一致<br><img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102216628.png?token=ADEGZTSI5MP6MBOSVFTOZZTCUNJJC" alt="Img"></p><p>而第三次的日志中，hive分配了两个application<br>分别为</p><ul class="lvl-0"><li class="lvl-2"><p><code>application_1651842678755_885385</code></p></li><li class="lvl-2"><p><code>application_1651842678755_885325</code><br>怀疑其中某个application的任务状态存在问题导致任务一直无法结束</p></li></ul><h3 id="故障复现">故障复现</h3><p>重跑任务复现现象：<br>2022/5/26 10:24:24重跑任务十分钟后发现该任务仍未结束<br><img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102217178.png?token=ADEGZTV6OHWS2OHQRGUCLOTCUNJMM" alt="Img"></p><p>查看任务日志，发现hive脚本实际早已执行完成，日志中显示执行已completed且hive已经关闭了客户端链接，说明脚本实际早已执行完成：</p><p><img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102218441.png?token=ADEGZTW2GKS7KFFUADMRWZDCUNJOS" alt="Img"></p><h3 id="日志分析">日志分析</h3><p>继续查看发现该任务同样生成两个application：</p><ul class="lvl-0"><li class="lvl-2"><p>application_1651842678755_887507</p></li><li class="lvl-2"><p>application_1651842678755_884350</p></li></ul><p>其中application_1651842678755_887507的状态很快进入finish状态</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn  application -status application_1651842678755_887507</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102219548.png?token=ADEGZTQ3SZYHSS26WVIYXATCUNJUO" alt="Img"></p><p>而application_1651842678755_884350的状态一直为running,且显示该任务的执行队列为default队列而非指定的专用队列</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn  application -status application_1651842678755_884350</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102222620.png?token=ADEGZTR67GA3XOC333KNMNLCUNJ6S" alt="Img"></p><p>检查脚本，脚本中已在sql运行前加入了指定队列的信息，脚本对应的任务应该都在专用队列提交：</p><p><img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102223670.png?token=ADEGZTUFJJR2QEF5C3E6Z6LCUNKDM" alt="Img"></p><p>从日志分析中可以发现两个明显的异常：</p><div class="danger"><ul class="lvl-1"><li class="lvl-2"><p>在指定了队列的前提下，为什么会有application被放在default队列执行</p></li><li class="lvl-2"><p>在hive客户端都已经执行完毕关闭链接的情况下，为什么会有application一直处于running的状态，而不转变为finish状态</p></li></ul></div><h2 id="问题解决-2">问题解决</h2><p>与HDP集群维护部门沟通，对方反馈如下：</p><blockquote><p>该现象由于集群负载过高引起，容器无法获得足够的资源导致状态一直卡在running。 而使用default队列是因为任务拆分多个application本身&gt; 就是由内部租户申请资源的，所以在default队列。</p></blockquote><p>个人对该说法存疑，但是由于我方并没有进一步排查问题的权限，只能想办法从工具层面规避该问题。从现象来看，DolphinScheduler(简称DS)工具在执行shell脚本后，会搜索脚本中是否存在applicationid,如果由则会取yarn中检查所有application的状态，当所有application的状态均为finish时，DS才认为脚本全部执行成空。实际上我们仅通过HIVE -E 本身反馈的状态值来判断脚本是否执行成功，而不需要检查application的状态。在DS的GITHUB中查询issue，发现类似问题解决方案：</p><p><a href="https://github.com/apache/dolphinscheduler/issues/5564">[Improvement][Worker] Do not verify the status of yarn in ShellCommandExecutor #5564</a></p><p>依据issue中的描述，修改<code>dolphinscheduler/server/worker/task/AbstractCommandExecutor.java</code>组件代码去除以下内容:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (status) &#123; </span><br><span class="line">    <span class="comment">// set appIds </span></span><br><span class="line">    List&lt;String&gt; appIds = getAppIds(taskExecutionContext.getLogPath()); </span><br><span class="line">    result.setAppIds(String.join(Constants.COMMA, appIds)); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// SHELL task state </span></span><br><span class="line">    result.setExitStatusCode(process.exitValue()); </span><br><span class="line"> </span><br><span class="line">    <span class="comment">// if yarn task , yarn state is final state </span></span><br><span class="line">    <span class="comment">// 删除下面的内容</span></span><br><span class="line">    <span class="keyword">if</span> (process.exitValue() == <span class="number">0</span>) &#123; </span><br><span class="line">        result.setExitStatusCode(isSuccessOfYarnState(appIds) ? EXIT_CODE_SUCCESS : EXIT_CODE_FAILURE); </span><br></pre></td></tr></table></figure><p>同时修改以下内容避免空指针问题:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (applicationStatus.equals(ExecutionStatus.FAILURE) </span><br><span class="line">     || applicationStatus.equals(ExecutionStatus.KILL)) &#123; </span><br><span class="line">     <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line"> &#125; </span><br><span class="line">  </span><br><span class="line"> <span class="keyword">if</span> (applicationStatus.equals(ExecutionStatus.SUCCESS)) &#123; </span><br><span class="line">     <span class="keyword">break</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">if</span> (ExecutionStatus.SUCCESS.equals(applicationStatus) &#123; </span><br><span class="line">     pass; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将程序重新打包后替换原来的<code>dolphinscheduler-server-1.3.8.jar</code></p><p>重启DS后重跑任务，两次均正常结束，</p><p><img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102224280.png?token=ADEGZTW4Q2RSRQSPBEDP3L3CUNKGK" alt="Img"></p><p>调整sql引出语法错误，检测出错时任务状态是否正常测试通过<br><img src="https://raw.githubusercontent.com/tang1990/mypic/main/202206102225527.png?token=ADEGZTWIQBWIVUFFBPRQLB3CUNKII" alt="Img"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1&gt;关于DS调度执行hive脚本吊死问题的分析及处理&lt;/h1&gt;
&lt;h2 id=&quot;问题现象&quot;&gt;问题现象&lt;/h2&gt;
&lt;p&gt;在DS执行hive脚本时,经常会出现hive任务实际执行完成，但对应的工作任务一致处于执行中状态无法结束的问题。&lt;/p&gt;
&lt;p&gt;在前两次运行,脚本均在三分钟内</summary>
      
    
    
    
    <category term="大数据" scheme="http://tang1990@github.io/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
    
    <category term="ds" scheme="http://tang1990@github.io/tags/ds/"/>
    
  </entry>
  
</feed>
